<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Slide;
use App\Services\ImageService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\DB;

class SlideAdminController extends Controller
{
    protected $imageService;

    public function __construct(ImageService $imageService)
    {
        $this->imageService = $imageService;
    }

    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $slides = Slide::with('translations.idioma')
                      ->orderBy('orden')
                      ->orderBy('created_at', 'desc')
                      ->get();
        
        return view('admin.slides.index', compact('slides'));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        $idiomas = \App\Models\Idioma::where('activo', true)->orderBy('orden')->get();
        
        return view('admin.slides.create', compact('idiomas'));
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        // Validación
        $rules = [
            'nueva_ventana' => 'boolean',
            'visible' => 'boolean',
            'activo' => 'boolean',
            'imagen' => 'nullable|image|mimes:jpeg,png,jpg,gif,webp|max:10240',
        ];

        // Validar traducciones por idioma
        $idiomas = \App\Models\Idioma::where('activo', true)->get();
        foreach ($idiomas as $idioma) {
            $rules["translations.{$idioma->id}.titulo"] = 'required|string|max:255';
            $rules["translations.{$idioma->id}.descripcion"] = 'nullable|string';
            $rules["translations.{$idioma->id}.alt_text"] = 'nullable|string|max:255';
            $rules["translations.{$idioma->id}.url"] = 'nullable|url';
        }

        $request->validate($rules);

        DB::beginTransaction();

        try {
            // Crear el slide
            $slide = Slide::create([
                'nueva_ventana' => $request->boolean('nueva_ventana'),
                'visible' => $request->boolean('visible', true),
                'activo' => $request->boolean('activo', true),
                // orden se genera automáticamente en el modelo
            ]);

            // Procesar imagen si se subió
            if ($request->hasFile('imagen')) {
                $this->processImage($request->file('imagen'), $slide);
            }

            // Guardar traducciones
            if ($request->has('translations')) {
                $slide->saveTranslations($request->input('translations'));
            }

            DB::commit();

            return redirect()
                ->route('admin.slides.index')
                ->with('success', 'Slide creado correctamente.');

        } catch (\Exception $e) {
            DB::rollBack();
            \Log::error('Error creating slide: ' . $e->getMessage());

            return back()
                ->withInput()
                ->with('error', 'Error al crear el slide: ' . $e->getMessage());
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(Slide $slide)
    {
        $slide->load('translations.idioma');
        
        return view('admin.slides.show', compact('slide'));
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(Slide $slide)
    {
        $slide->load('translations.idioma');
        $idiomas = \App\Models\Idioma::where('activo', true)->orderBy('orden')->get();
        
        // Preparar traducciones por idioma
        $translations = [];
        foreach ($idiomas as $idioma) {
            $translation = $slide->translations()->where('idioma_id', $idioma->id)->first();
            $translations[$idioma->id] = [
                'titulo' => $translation->titulo ?? '',
                'descripcion' => $translation->descripcion ?? '',
                'alt_text' => $translation->alt_text ?? '',
                'url' => $translation->url ?? '',
            ];
        }
        
        return view('admin.slides.edit', compact('slide', 'idiomas', 'translations'));
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, Slide $slide)
    {
        // Validación
        $rules = [
            'nueva_ventana' => 'boolean',
            'visible' => 'boolean',
            'activo' => 'boolean',
            'imagen' => 'nullable|image|mimes:jpeg,png,jpg,gif,webp|max:10240',
        ];

        // Validar traducciones por idioma
        $idiomas = \App\Models\Idioma::where('activo', true)->get();
        foreach ($idiomas as $idioma) {
            $rules["translations.{$idioma->id}.titulo"] = 'required|string|max:255';
            $rules["translations.{$idioma->id}.descripcion"] = 'nullable|string';
            $rules["translations.{$idioma->id}.alt_text"] = 'nullable|string|max:255';
            $rules["translations.{$idioma->id}.url"] = 'nullable|url';
        }

        $request->validate($rules);

        DB::beginTransaction();

        try {
            // Actualizar datos del slide
            $slide->update([
                'nueva_ventana' => $request->boolean('nueva_ventana'),
                'visible' => $request->boolean('visible'),
                'activo' => $request->boolean('activo'),
            ]);

            // Procesar nueva imagen si se subió
            if ($request->hasFile('imagen')) {
                // Eliminar imagen anterior
                $this->deleteSlideImages($slide);
                
                // Procesar nueva imagen
                $this->processImage($request->file('imagen'), $slide);
            }

            // Guardar traducciones
            if ($request->has('translations')) {
                $slide->saveTranslations($request->input('translations'));
            }

            DB::commit();

            return redirect()
                ->route('admin.slides.index')
                ->with('success', 'Slide actualizado correctamente.');

        } catch (\Exception $e) {
            DB::rollBack();
            \Log::error('Error updating slide: ' . $e->getMessage());

            return back()
                ->withInput()
                ->with('error', 'Error al actualizar el slide: ' . $e->getMessage());
        }
    }
                    'slide',
                    'imagen',
                    $slide->id
                );

                if (!$imagePath) {
                    throw new \Exception('Error al procesar la nueva imagen');
                }

                $slide->imagen = $imagePath;

                // Generar nueva miniatura
                $miniaturaPath = $this->imageService->processAndSaveImage(
                    $request->file('imagen'),
                    'slide',
                    'imagen_miniatura',
                    $slide->id
                );

                $slide->imagen_miniatura = $miniaturaPath;

                // Actualizar metadatos
                $slide->metadatos = $this->imageService->getImageMetadata($request->file('imagen'));

                // Eliminar archivos antiguos después de confirmar que los nuevos están bien
                if ($oldImagePath && $oldImagePath !== $imagePath) {
                    Storage::disk('public')->delete($oldImagePath);
                }
                if ($oldMiniaturaPath && $oldMiniaturaPath !== $miniaturaPath) {
                    Storage::disk('public')->delete($oldMiniaturaPath);
                }
            }

            $slide->save();
            
            DB::commit();

            return redirect()->route('admin.slides.index')
                           ->with('success', 'Slide actualizado exitosamente.');
                           
        } catch (\Exception $e) {
            DB::rollback();
            
            \Log::error('Error actualizando slide: ' . $e->getMessage());
            
            return back()->withInput()
                        ->withErrors(['error' => 'Error al actualizar el slide: ' . $e->getMessage()]);
        }
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(Slide $slide)
    {
        try {
            DB::beginTransaction();

            // Guardar rutas de archivos para eliminar
            $imagePath = $slide->imagen;
            $miniaturaPath = $slide->imagen_miniatura;

            // Eliminar el slide
            $slide->delete();

            // Eliminar archivos de imagen
            if ($imagePath) {
                Storage::disk('public')->delete($imagePath);
            }
            if ($miniaturaPath) {
                Storage::disk('public')->delete($miniaturaPath);
            }

            DB::commit();

            return redirect()->route('admin.slides.index')
                           ->with('success', 'Slide eliminado exitosamente.');
                           
        } catch (\Exception $e) {
            DB::rollback();
            
            \Log::error('Error eliminando slide: ' . $e->getMessage());
            
            return back()->withErrors(['error' => 'Error al eliminar el slide: ' . $e->getMessage()]);
        }
    }

    /**
     * Actualizar orden de los slides
     */
    public function updateOrder(Request $request)
    {
        $request->validate([
            'slides' => 'required|array',
            'slides.*.id' => 'required|integer|exists:slides,id',
            'slides.*.orden' => 'required|integer|min:1'
        ]);

        try {
            DB::beginTransaction();

            foreach ($request->slides as $slideData) {
                Slide::where('id', $slideData['id'])
                     ->update(['orden' => $slideData['orden']]);
            }

            DB::commit();

            return response()->json(['success' => true, 'message' => 'Orden actualizado correctamente']);
            
        } catch (\Exception $e) {
            DB::rollback();
            
            \Log::error('Error actualizando orden de slides: ' . $e->getMessage());
            
            return response()->json(['success' => false, 'message' => 'Error al actualizar orden'], 500);
        }
    }

    /**
     * Process uploaded image
     */
    private function processImage($file, Slide $slide)
    {
        $imagePaths = $this->imageService->processImage(
            $file,
            'slides',
            'slide-' . $slide->id
        );

        $slide->update([
            'imagen' => $imagePaths['desktop'] ?? null,
            'imagen_miniatura' => $imagePaths['thumbnail'] ?? null,
            'metadatos' => array_merge($slide->metadatos ?? [], [
                'original_name' => $file->getClientOriginalName(),
                'file_size' => $file->getSize(),
                'mime_type' => $file->getMimeType(),
                'processed_at' => now()->toISOString()
            ])
        ]);
    }

    /**
     * Delete slide images from storage
     */
    private function deleteSlideImages(Slide $slide)
    {
        $imagesToDelete = array_filter([
            $slide->imagen,
            $slide->imagen_miniatura
        ]);

        foreach ($imagesToDelete as $imagePath) {
            if (Storage::disk('public')->exists($imagePath)) {
                Storage::disk('public')->delete($imagePath);
            }
        }
    }
}
