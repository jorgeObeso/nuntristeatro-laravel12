@extends('admin.layouts.app')

@section('title', 'Crear Men√∫')

@section('content_header')
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">Crear Nuevo Men√∫</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ route('admin.dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{{ route('admin.menus.index') }}">Men√∫s</a></li>
                        <li class="breadcrumb-item active">Crear</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
@stop

@section('content')
<div class="container-fluid">
    <form action="{{ route('admin.menus.store') }}" method="POST" id="menuForm">
        @csrf
        
        <div class="row">
            <!-- Configuraci√≥n Principal -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-cog"></i> Configuraci√≥n Principal
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Men√∫ Padre -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="parent_id">Men√∫ Padre</label>
                                    <select name="parent_id" id="parent_id" class="form-control">
                                        <option value="">Men√∫ Principal</option>
                                        @foreach($menusParent as $menuParent)
                                            <option value="{{ $menuParent->id }}">
                                                {{ $menuParent->titulo }}
                                            </option>
                                        @endforeach
                                    </select>
                                    <small class="form-text text-muted">Selecciona un men√∫ padre si deseas crear un submen√∫.</small>
                                </div>
                            </div>
                            
                            <!-- Orden -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="orden">Orden de Aparici√≥n</label>
                                    <input type="number" name="orden" id="orden" class="form-control @error('orden') is-invalid @enderror" 
                                           value="{{ old('orden', 1) }}" min="1">
                                    @error('orden')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                        <!-- Tipo de Enlace -->
                        <div class="form-group">
                            <label for="tipo_enlace">Tipo de Enlace</label>
                            <select name="tipo_enlace" id="tipo_enlace" class="form-control @error('tipo_enlace') is-invalid @enderror">
                                <option value="contenido" {{ old('tipo_enlace', 'contenido') == 'contenido' ? 'selected' : '' }}>
                                    Enlazar a Contenido Existente
                                </option>
                                <option value="url_externa" {{ old('tipo_enlace') == 'url_externa' ? 'selected' : '' }}>
                                    URL Externa
                                </option>
                                <option value="ninguno" {{ old('tipo_enlace') == 'ninguno' ? 'selected' : '' }}>
                                    Sin Enlace (Solo T√≠tulo)
                                </option>
                            </select>
                            @error('tipo_enlace')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        <!-- Bot√≥n de prueba AJAX (temporal) -->
                        <div class="alert alert-info" style="display: none;">
                            <strong>Debug:</strong> 
                            <button type="button" id="test-ajax" class="btn btn-sm btn-primary">Probar AJAX</button>
                            <div id="ajax-result" class="mt-2"></div>
                        </div>

                        <!-- Configuraci√≥n de Contenido -->
                        <div id="contenido-config" class="content-config">
                            <!-- Informaci√≥n de debug (temporal para verificar datos) -->
                            <div class="alert alert-warning">
                                <strong>Debug - Contenidos por tipo:</strong><br>
                                <pre>{{ print_r($contenidosPorTipo ?? 'Variable no definida', true) }}</pre>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="tipo_contenido_id">Tipo de Contenido</label>
                                        <select name="tipo_contenido_id" id="tipo_contenido_id" class="form-control">
                                            <option value="">Seleccione un tipo</option>
                                            @foreach($tiposContenido as $tipo)
                                                <option value="{{ $tipo->id }}" {{ old('tipo_contenido_id') == $tipo->id ? 'selected' : '' }}>
                                                    {{ $tipo->nombre }}
                                                </option>
                                            @endforeach
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="content_id">Contenido Espec√≠fico</label>
                                        <select name="content_id" id="content_id" class="form-control">
                                            <option value="">Primero seleccione un tipo</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- URL Externa -->
                        <div id="url-config" class="content-config" style="display: none;">
                            <div class="form-group">
                                <label for="url">URL Externa</label>
                                <input type="url" name="url" id="url" class="form-control @error('url') is-invalid @enderror" 
                                       value="{{ old('url') }}" placeholder="https://ejemplo.com">
                                @error('url')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                                <small class="form-text text-muted">
                                    Ejemplo: https://www.google.com o https://facebook.com/tupagina
                                </small>
                            </div>
                        </div>

                        <!-- Opciones adicionales -->
                        <div class="form-group">
                            <label>Opciones Adicionales</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="abrir_nueva_ventana" 
                                       name="abrir_nueva_ventana" value="1" {{ old('abrir_nueva_ventana') ? 'checked' : '' }}>
                                <label class="form-check-label" for="abrir_nueva_ventana">
                                    Abrir en nueva ventana (solo para URLs externas)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- T√≠tulos Multiidioma -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-language"></i> T√≠tulos en Diferentes Idiomas
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="nav nav-tabs" id="nav-tab" role="tablist">
                            @foreach($idiomas as $index => $idioma)
                                <a class="nav-item nav-link {{ $index === 0 ? 'active' : '' }}" 
                                   id="nav-{{ $idioma->etiqueta }}-tab" data-bs-toggle="tab" 
                                   href="#nav-{{ $idioma->etiqueta }}" role="tab" 
                                   aria-controls="nav-{{ $idioma->etiqueta }}" 
                                   aria-selected="{{ $index === 0 ? 'true' : 'false' }}">
                                    {{ $idioma->nombre }}
                                    @if($idioma->es_principal)
                                        <span class="badge badge-primary ml-1">Principal</span>
                                    @endif
                                </a>
                            @endforeach
                        </div>
                        
                        <div class="tab-content" id="nav-tabContent">
                            @foreach($idiomas as $index => $idioma)
                                <div class="tab-pane fade {{ $index === 0 ? 'show active' : '' }}" 
                                     id="nav-{{ $idioma->etiqueta }}" role="tabpanel" 
                                     aria-labelledby="nav-{{ $idioma->etiqueta }}-tab">
                                    <div class="form-group mt-3">
                                        <label for="textos_{{ $idioma->id }}_titulo">
                                            T√≠tulo del Men√∫ ({{ $idioma->nombre }})
                                            @if($idioma->es_principal)
                                                <span class="text-danger">*</span>
                                            @endif
                                        </label>
                                        <input type="text" 
                                               name="textos[{{ $idioma->id }}][titulo]" 
                                               id="textos_{{ $idioma->id }}_titulo"
                                               class="form-control @error('textos.'.$idioma->id.'.titulo') is-invalid @enderror" 
                                               value="{{ old('textos.'.$idioma->id.'.titulo') }}"
                                               {{ $idioma->es_principal ? 'required' : '' }}>
                                        @error('textos.'.$idioma->id.'.titulo')
                                            <div class="invalid-feedback">{{ $message }}</div>
                                        @enderror
                                    </div>
                                </div>
                            @endforeach
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel de Opciones -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-cogs"></i> Opciones de Visibilidad
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="visible" name="visible" 
                                       value="1" {{ old('visible', true) ? 'checked' : '' }}>
                                <label class="custom-control-label" for="visible">
                                    <strong>Men√∫ Visible</strong>
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                Si est√° desactivado, el men√∫ no aparecer√° en la web.
                            </small>
                        </div>

                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="abrir_nueva_ventana" 
                                       name="abrir_nueva_ventana" value="1" {{ old('abrir_nueva_ventana') ? 'checked' : '' }}>
                                <label class="custom-control-label" for="abrir_nueva_ventana">
                                    <strong>Abrir en Nueva Ventana</strong>
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                Solo aplica para URLs externas.
                            </small>
                        </div>

                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="menu_pie" 
                                       name="menu_pie" value="1" {{ old('menu_pie') ? 'checked' : '' }}>
                                <label class="custom-control-label" for="menu_pie">
                                    <strong>Incluir en Men√∫ de Pie</strong>
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                Aparecer√° tambi√©n en el footer del sitio.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acci√≥n -->
                <div class="card">
                    <div class="card-body">
                        <button type="submit" class="btn btn-success btn-block">
                            <i class="fas fa-save"></i> Guardar Men√∫
                        </button>
                        <a href="{{ route('admin.menus.index') }}" class="btn btn-secondary btn-block">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
@stop

@section('css')
<style>
.content-config {
    transition: all 0.3s ease;
}
.icon-preview {
    font-size: 1.2em;
}
.nav-tabs .nav-link.active {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}
</style>
@stop

@section('js')
<script>
@push('scripts')
<!-- Test b√°sico inline -->
<script>
alert('üöÄ JAVASCRIPT SE EST√Å EJECUTANDO!');
console.log('üöÄ SCRIPT CARGADO - INICIO');
</script>

<script>
// DEBUG ULTRA B√ÅSICO
console.log('üöÄ SCRIPT CARGADO - INICIO');

// Verificar si jQuery est√° disponible
if (typeof $ === 'undefined') {
    console.error('‚ùå jQuery NO est√° cargado');
    alert('‚ùå jQuery NO est√° cargado');
    // Cargar jQuery manualmente si no est√° disponible
    var script = document.createElement('script');
    script.src = 'https://code.jquery.com/jquery-3.7.1.min.js';
    script.onload = function() {
        console.log('‚úÖ jQuery cargado manualmente');
        inicializarMenus();
    };
    document.head.appendChild(script);
} else {
    console.log('‚úÖ jQuery est√° disponible');
    alert('‚úÖ jQuery est√° disponible');
    $(document).ready(function() {
        inicializarMenus();
    });
}

function inicializarMenus() {
    console.log('üéØ INICIANDO SISTEMA DE MEN√öS');
    
    // Verificar elementos
    const elementos = ['#tipo_enlace', '#tipo_contenido_id', '#content_id'];
    elementos.forEach(function(selector) {
        const elemento = $(selector);
        console.log('Elemento ' + selector + ':', elemento.length > 0 ? '‚úÖ EXISTE' : '‚ùå NO EXISTE');
    });

    // 1. Manejar cambio de tipo de enlace
    $('#tipo_enlace').on('change', function() {
        const tipo = $(this).val();
        console.log('üìù Tipo enlace cambiado a:', tipo);
        
        $('.content-config').hide();
        
        if (tipo === 'contenido') {
            $('#contenido-config').show();
            console.log('‚úÖ Mostrando config contenido');
        } else if (tipo === 'url_externa') {
            $('#url-config').show();
            console.log('‚úÖ Mostrando config URL');
        }
    });

    // 2. Manejar cambio de tipo de contenido - MUY SIMPLE
    $('#tipo_contenido_id').on('change', function() {
        const tipoId = $(this).val();
        console.log('üîç Tipo contenido seleccionado:', tipoId);
        
        const $select = $('#content_id');
        console.log('Select contenido encontrado:', $select.length > 0 ? 'S√ç' : 'NO');
        
        if (!tipoId) {
            $select.html('<option value="">Seleccione primero un tipo</option>');
            console.log('‚ùå Sin tipo - reseteando');
            return;
        }
        
        // Mostrar cargando
        $select.html('<option value="">üîÑ Cargando...</option>');
        console.log('‚è≥ Estado: Cargando...');
        
        // Datos hardcodeados
        const datos = {
            '3': [
                {id: 8, titulo: 'titulo espa√±ol'},
                {id: 9, titulo: 'Noticia de Ejemplo 2'}
            ]
        };
        
        // Simular carga
        setTimeout(function() {
            const contenidos = datos[tipoId] || [];
            console.log('üìä Datos para tipo', tipoId + ':', contenidos);
            
            $select.html('<option value="">Seleccione un contenido</option>');
            
            if (contenidos.length > 0) {
                contenidos.forEach(function(item) {
                    console.log('‚ûï Agregando:', item.titulo);
                    $select.append($('<option>', {
                        value: item.id,
                        text: item.titulo
                    }));
                });
                console.log('ÔøΩ ¬°DROPDOWN POBLADO!');
            } else {
                $select.append('<option value="">Sin contenidos</option>');
                console.log('‚ö†Ô∏è Sin contenidos para tipo ' + tipoId);
            }
        }, 500);
    });

@push('scripts')
<script src="{{ asset('js/menu-create.js') }}"></script>
@endpush