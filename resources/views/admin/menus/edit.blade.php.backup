@extends('admin.layouts.app')

@section('title', 'Editar Menú')

@section('content_header')
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">Editar Menú: {{ $menu->titulo }}</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{ route('admin.dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{{ route('admin.menus.index') }}">Menús</a></li>
                        <li class="breadcrumb-item active">Editar</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
@stop

@section('content')
<div class="container-fluid">
    <form action="{{ route('admin.menus.update', $menu) }}" method="POST" id="menuForm">
        @csrf
        @method('PUT')
        
        <div class="row">
            <!-- Configuración Principal -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-cog"></i> Configuración Principal
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Menú Padre -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="parent_id">Menú Padre</label>
                                    <select name="parent_id" id="parent_id" class="form-control">
                                        <option value="">Menú Principal</option>
                                        @foreach($menusParent as $menuParent)
                                            <option value="{{ $menuParent->id }}" 
                                                {{ old('parent_id', $menu->parent_id) == $menuParent->id ? 'selected' : '' }}>
                                                {{ $menuParent->titulo }}
                                            </option>
                                        @endforeach
                                    </select>
                                    <small class="form-text text-muted">Selecciona un menú padre si deseas crear un submenú.</small>
                                </div>
                            </div>
                            
                            <!-- Orden -->
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="orden">Orden de Aparición</label>
                                    <input type="number" name="orden" id="orden" class="form-control @error('orden') is-invalid @enderror" 
                                           value="{{ old('orden', $menu->orden) }}" min="1">
                                    @error('orden')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                        <!-- Tipo de Enlace -->
                        <div class="form-group">
                            <label for="tipo_enlace">Tipo de Enlace</label>
                            <select name="tipo_enlace" id="tipo_enlace" class="form-control @error('tipo_enlace') is-invalid @enderror">
                                <option value="contenido" {{ old('tipo_enlace', $menu->tipo_enlace) == 'contenido' ? 'selected' : '' }}>
                                    Enlazar a Contenido Existente
                                </option>
                                <option value="url_externa" {{ old('tipo_enlace', $menu->tipo_enlace) == 'url_externa' ? 'selected' : '' }}>
                                    URL Externa
                                </option>
                                <option value="ninguno" {{ old('tipo_enlace', $menu->tipo_enlace) == 'ninguno' ? 'selected' : '' }}>
                                    Sin Enlace (Solo Título)
                                </option>
                            </select>
                            @error('tipo_enlace')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        <!-- Configuración de Contenido -->
                        <div id="contenido-config" class="content-config">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="tipo_contenido_id">Tipo de Contenido</label>
                                        <select name="tipo_contenido_id" id="tipo_contenido_id" class="form-control">
                                            <option value="">Seleccione un tipo</option>
                                            @foreach($tiposContenido as $tipo)
                                                <option value="{{ $tipo->id }}" 
                                                    {{ old('tipo_contenido_id', $menu->tipo_contenido_id) == $tipo->id ? 'selected' : '' }}>
                                                    {{ $tipo->nombre }}
                                                </option>
                                            @endforeach
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="content_id">Contenido Específico</label>
                                        <select name="content_id" id="content_id" class="form-control">
                                            <option value="">Seleccione un contenido</option>
                                            @if($menu->content)
                                                <option value="{{ $menu->content->id }}" selected>
                                                    {{ $menu->content->titulo }}
                                                </option>
                                            @endif
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- URL Externa -->
                        <div id="url-config" class="content-config" style="display: none;">
                            <div class="form-group">
                                <label for="url">URL Externa</label>
                                <input type="url" name="url" id="url" class="form-control @error('url') is-invalid @enderror" 
                                       value="{{ old('url', $menu->url) }}" placeholder="https://ejemplo.com">
                                @error('url')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                                <small class="form-text text-muted">
                                    Ejemplo: https://www.google.com o https://facebook.com/tupagina
                                </small>
                            </div>
                        </div>

                        <!-- Opciones adicionales -->
                        <div class="form-group">
                            <label>Opciones Adicionales</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="abrir_nueva_ventana" 
                                       name="abrir_nueva_ventana" value="1" 
                                       {{ old('abrir_nueva_ventana', $menu->abrir_nueva_ventana) ? 'checked' : '' }}>
                                <label class="form-check-label" for="abrir_nueva_ventana">
                                    Abrir en nueva ventana (solo para URLs externas)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Títulos Multiidioma -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-language"></i> Títulos en Diferentes Idiomas
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="nav nav-tabs" id="nav-tab" role="tablist">
                            @foreach($idiomas as $index => $idioma)
                                <a class="nav-item nav-link {{ $index === 0 ? 'active' : '' }}" 
                                   id="nav-{{ $idioma->etiqueta }}-tab" data-bs-toggle="tab" 
                                   href="#nav-{{ $idioma->etiqueta }}" role="tab" 
                                   aria-controls="nav-{{ $idioma->etiqueta }}" 
                                   aria-selected="{{ $index === 0 ? 'true' : 'false' }}">
                                    {{ $idioma->nombre }}
                                    @if($idioma->es_principal)
                                        <span class="badge badge-primary ml-1">Principal</span>
                                    @endif
                                </a>
                            @endforeach
                        </div>
                        
                        <div class="tab-content" id="nav-tabContent">
                            @foreach($idiomas as $index => $idioma)
                                @php
                                    $textoExistente = $menu->textos->where('idioma_id', $idioma->id)->where('campo', 'titulo')->first();
                                @endphp
                                <div class="tab-pane fade {{ $index === 0 ? 'show active' : '' }}" 
                                     id="nav-{{ $idioma->etiqueta }}" role="tabpanel" 
                                     aria-labelledby="nav-{{ $idioma->etiqueta }}-tab">
                                    <div class="form-group mt-3">
                                        <label for="textos_{{ $idioma->id }}_titulo">
                                            Título del Menú ({{ $idioma->nombre }})
                                            @if($idioma->es_principal)
                                                <span class="text-danger">*</span>
                                            @endif
                                        </label>
                                        <input type="text" 
                                               name="textos[{{ $idioma->id }}][titulo]" 
                                               id="textos_{{ $idioma->id }}_titulo"
                                               class="form-control @error('textos.'.$idioma->id.'.titulo') is-invalid @enderror" 
                                               value="{{ old('textos.'.$idioma->id.'.titulo', $textoExistente ? $textoExistente->texto : '') }}"
                                               {{ $idioma->es_principal ? 'required' : '' }}>
                                        @error('textos.'.$idioma->id.'.titulo')
                                            <div class="invalid-feedback">{{ $message }}</div>
                                        @enderror
                                    </div>
                                </div>
                            @endforeach
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel de Opciones -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-cogs"></i> Opciones de Visibilidad
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="visible" name="visible" 
                                       value="1" {{ old('visible', $menu->visible) ? 'checked' : '' }}>
                                <label class="custom-control-label" for="visible">
                                    <strong>Menú Visible</strong>
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                Si está desactivado, el menú no aparecerá en la web.
                            </small>
                        </div>

                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="abrir_nueva_ventana" 
                                       name="abrir_nueva_ventana" value="1" 
                                       {{ old('abrir_nueva_ventana', $menu->abrir_nueva_ventana) ? 'checked' : '' }}>
                                <label class="custom-control-label" for="abrir_nueva_ventana">
                                    <strong>Abrir en Nueva Ventana</strong>
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                Solo aplica para URLs externas.
                            </small>
                        </div>

                        <div class="form-group">
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="menu_pie" 
                                       name="menu_pie" value="1" 
                                       {{ old('menu_pie', $menu->menu_pie) ? 'checked' : '' }}>
                                <label class="custom-control-label" for="menu_pie">
                                    <strong>Incluir en Menú de Pie</strong>
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                Aparecerá también en el footer del sitio.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Información del Menú -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-info"></i> Información
                        </h3>
                    </div>
                    <div class="card-body">
                        <p><strong>Creado:</strong> {{ $menu->created_at->format('d/m/Y H:i') }}</p>
                        <p><strong>Actualizado:</strong> {{ $menu->updated_at->format('d/m/Y H:i') }}</p>
                        @if($menu->children->count() > 0)
                            <p><strong>Submenús:</strong> {{ $menu->children->count() }}</p>
                        @endif
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="card">
                    <div class="card-body">
                        <button type="submit" class="btn btn-success btn-block">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                        <a href="{{ route('admin.menus.show', $menu) }}" class="btn btn-info btn-block">
                            <i class="fas fa-eye"></i> Ver Menú
                        </a>
                        <a href="{{ route('admin.menus.index') }}" class="btn btn-secondary btn-block">
                            <i class="fas fa-arrow-left"></i> Volver al Listado
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
@stop

@section('css')
<style>
.content-config {
    transition: all 0.3s ease;
}
.icon-preview {
    font-size: 1.2em;
}
.nav-tabs .nav-link.active {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}
</style>
@stop

@section('js')
<script>
console.log('=== CARGANDO SCRIPT DE EDICIÓN ===');

$(document).ready(function() {
    console.log('=== SISTEMA DE EDICIÓN DE MENÚS INICIADO ===');
    
    // Verificar que todos los elementos existan
    const elementos = {
        tipo_enlace: $('#tipo_enlace'),
        tipo_contenido_id: $('#tipo_contenido_id'),
        content_id: $('#content_id'),
        contenido_config: $('#contenido-config'),
        url_config: $('#url-config')
    };
    
    console.log('Verificando elementos:');
    Object.keys(elementos).forEach(key => {
        console.log(`- ${key}: ${elementos[key].length > 0 ? '✅' : '❌'} (${elementos[key].length})`);
    });

    // Valores iniciales para la edición
    const valoresIniciales = {
        contentId: '{{ old('content_id', $menu->content_id) }}',
        tipoEnlace: elementos.tipo_enlace.val(),
        tipoContenido: elementos.tipo_contenido_id.val()
    };
    
    console.log('Valores iniciales:', valoresIniciales);

    // Función para mostrar/ocultar campos según tipo de enlace
    function actualizarCamposEnlace() {
        const tipo = elementos.tipo_enlace.val();
        console.log('Actualizando campos para tipo:', tipo);
        
        // Ocultar todos primero
        $('.content-config').hide();
        
        // Limpiar selects cuando cambiamos de tipo (solo si no es la carga inicial)
        if (tipo !== 'contenido' && tipo !== valoresIniciales.tipoEnlace) {
            elementos.tipo_contenido_id.val('');
            elementos.content_id.html('<option value="">Seleccione primero un tipo</option>');
        }
        
        // Mostrar campos según tipo
        if (tipo === 'contenido') {
            elementos.contenido_config.show();
            console.log('Mostrando configuración de contenido');
        } else if (tipo === 'url_externa') {
            elementos.url_config.show();
            console.log('Mostrando configuración de URL');
        }
    }

    // Event listener para tipo de enlace
    elementos.tipo_enlace.on('change', actualizarCamposEnlace);

    // Función para cargar contenidos específicos
    function cargarContenidos() {
        const tipoId = elementos.tipo_contenido_id.val();
        const currentContentId = valoresIniciales.contentId;
        
        console.log('=== CARGANDO CONTENIDOS ===');
        console.log('Tipo ID seleccionado:', tipoId);
        console.log('Content ID actual:', currentContentId);
        
        // Resetear select
        elementos.content_id.html('<option value="">Cargando...</option>').prop('disabled', true);
        
        if (!tipoId) {
            elementos.content_id.html('<option value="">Seleccione primero un tipo</option>').prop('disabled', true);
            console.log('Sin tipo seleccionado');
            return;
        }
        
        console.log('Iniciando petición AJAX...');
        
        // Petición AJAX
        $.ajax({
            url: '/admin/menus-contents-by-type',
            method: 'GET',
            data: { tipo_contenido_id: tipoId },
            dataType: 'json',
            timeout: 10000,
            beforeSend: function(xhr) {
                console.log('AJAX: Enviando petición a URL:', this.url);
                console.log('AJAX: Datos enviados:', this.data);
            },
            success: function(data) {
                console.log('AJAX: Éxito - Datos recibidos:', data);
                
                // Limpiar y agregar opción por defecto
                elementos.content_id.html('<option value="">Seleccione un contenido</option>');
                
                if (Array.isArray(data) && data.length > 0) {
                    console.log(`AJAX: Procesando ${data.length} elementos`);
                    
                    data.forEach(function(item, index) {
                        console.log(`Item ${index}:`, item);
                        
                        const isSelected = item.id == currentContentId;
                        console.log(`¿Seleccionado? ${isSelected} (${item.id} == ${currentContentId})`);
                        
                        const option = $('<option></option>')
                            .attr('value', item.id)
                            .text(item.titulo)
                            .prop('selected', isSelected);
                        
                        elementos.content_id.append(option);
                    });
                    
                    elementos.content_id.prop('disabled', false);
                    console.log('AJAX: Contenidos cargados exitosamente');
                } else {
                    elementos.content_id.append('<option value="">No hay contenidos disponibles</option>');
                    elementos.content_id.prop('disabled', true);
                    console.log('AJAX: Sin contenidos disponibles');
                }
                
                console.log('AJAX: HTML final del select:', elementos.content_id.html());
            },
            error: function(xhr, status, error) {
                console.error('AJAX: Error completo');
                console.error('- XHR:', xhr);
                console.error('- Status:', status);
                console.error('- Error:', error);
                console.error('- Response Text:', xhr.responseText);
                
                elementos.content_id.html('<option value="">Error: ' + error + '</option>');
                elementos.content_id.prop('disabled', true);
            },
            complete: function() {
                console.log('AJAX: Petición completada');
            }
        });
    }

    // Event listener para tipo de contenido
    elementos.tipo_contenido_id.on('change', cargarContenidos);

    // Inicializar estado
    console.log('Inicializando estado...');
    actualizarCamposEnlace();
    
    // Si ya hay un tipo de contenido seleccionado, cargar sus contenidos
    if (valoresIniciales.tipoContenido) {
        console.log('Cargando contenidos iniciales para tipo:', valoresIniciales.tipoContenido);
        cargarContenidos();
    }
    
    console.log('=== SISTEMA DE EDICIÓN COMPLETAMENTE INICIADO ===');
});
</script>
@stop